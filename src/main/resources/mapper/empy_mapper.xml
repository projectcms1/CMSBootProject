<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cms.ca.employee.EmployeeRepository">

	<select id="getEmployeeInfo" resultType="com.cms.ca.employee_dto" parameterType="String">
		select * from EMP_INFO where emp_no = #{emp_no}
	</select>

	<update id="updatePersonalEmployeeInfo" parameterType="com.cms.ca.employee_dto">
		update EMP_INFO 
		set emp_eml_addr =#{emp_eml_addr}, emp_telno=#{emp_telno}
		where emp_no=#{emp_no}
	</update>
	
	<update id="updateAddrEmployeeInfo" parameterType="com.cms.ca.employee_dto">
		update EMP_INFO 
		set emp_zip =#{emp_zip}, emp_addr=#{emp_addr}, emp_daddr=#{emp_daddr}
		where emp_no=#{emp_no}
	</update>
	
	<update id="updateBankEmployeeInfo" parameterType="com.cms.ca.employee_dto">
		update EMP_INFO 
		set dlng_bank_nm =#{dlng_bank_nm}, dlng_actno=#{dlng_actno}
		where emp_no=#{emp_no}
	</update>
	
	<select id="getStdntNameFromStdNo" resultType="String" parameterType="String">
		select stdnt_flnm from STDNT_INFO where stdnt_no = #{stdnt_no}
	</select>
	
	<insert id="addCounsel" parameterType="com.cms.ca.counsel_dto">
		insert into DSCSN_APLY 
		(aply_sn, bfr_aply_sn, hr_se, stdnt_no, emp_no, stts_cd, 
		plc, rsvt_dt, aply_dt, dscsn_mthd, dscsn_knd)
		values 
		('0', null, #{hr_se}, #{stdnt_no}, #{emp_no}, #{stts_cd}, 
		#{plc}, #{rsvt_dt}, now(), #{dscsn_mthd}, #{dscsn_knd})
	</insert>
	
	<select id="getAllCounsel" parameterType="HashMap" resultType="com.cms.ca.view_counsel_dto">
		select * from VIEW_DSCSN_APLY 
		where emp_no=#{emp_no} and bfr_aply_sn is null and stts_cd=#{stts_cd}
		<include refid="search" />
		order by aply_sn desc 
		limit #{offset}, #{size}
	</select>
	
	<select id="getAllCounselCount" parameterType="HashMap" resultType="int">
		select count(*) as cnt from VIEW_DSCSN_APLY 
		where emp_no=#{emp_no} and bfr_aply_sn is null and stts_cd=#{stts_cd}
		<include refid="search" />
	</select>
	
	<sql id="search">
        <!-- 검색 키워드가 있을 때 -->
        <if test="searchValue != null and searchValue != ''">
            <choose>
	            <when test="'rsvt_dt'.equals( searchType )">
	            	AND rsvt_dt LIKE CONCAT('%', #{searchValue}, '%')
	            </when>
	            <when test="'stdnt_flnm'.equals( searchType )">
	            	AND stdnt_flnm LIKE CONCAT('%', #{searchValue}, '%')
	            </when>
	            <when test="'stdnt_no'.equals( searchType )">
	            	AND stdnt_no LIKE CONCAT('%', #{searchValue}, '%')
	            </when>
            	<when test="'all'.equals( searchType )">
            		AND (
            			rsvt_dt LIKE CONCAT('%', #{searchValue}, '%')
            			OR stdnt_flnm LIKE CONCAT('%', #{searchValue}, '%')
            			OR stdnt_no LIKE CONCAT('%', #{searchValue}, '%')
            		)
            	</when>
            </choose>
        </if>
    </sql>
	
	<select id="getOneCounsel" parameterType="HashMap" resultType="com.cms.ca.view_counsel_dto">
		select * from VIEW_DSCSN_APLY 
		where (aply_sn=#{aply_sn} or bfr_aply_sn=#{aply_sn})
		order by aply_sn asc 
	</select>
	
	<select id="getCounselResult" parameterType="int" resultType="String">
		select dscsn_cn from DSCSN_RSLT 
		where aply_sn=#{aply_sn}
		order by aply_sn asc 
	</select>
	
	<select id="getPastCounsel" parameterType="HashMap" resultType="com.cms.ca.view_counsel_dto">
		select * from VIEW_DSCSN_APLY 
		where emp_no=#{emp_no} and bfr_aply_sn is null and (stts_cd="완료" or stts_cd="취소")
		<include refid="search" />
		order by aply_sn desc 
		limit #{offset}, #{size}
	</select>
	
	<update id="updateCounselStatus" parameterType="HashMap">
		update DSCSN_APLY 
		set stts_cd=#{stts_cd}
		where aply_sn=#{aply_sn} 
	</update>
	
</mapper>